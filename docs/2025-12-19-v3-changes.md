# Architecture v3: Changes Document

> Review notes from v2 → v3 refinement. Each change includes rationale.
> After full review, create fresh v3 document incorporating all changes.

---

## Changes

### 1. URL Structure: `/u/:username/` → `/me/`

**Section affected:** Core Design Decisions > User-Specific Marketplaces

**Change:**
- Old: `https://skaas.com/u/alice/marketplace.git`
- New: `https://skaas.com/me/marketplace.git`

**Rationale:**
- Token already identifies the user — username in URL is redundant
- `/me/` is semantic and self-explanatory
- Provides optionality for future (e.g., `/enterprise/:org/marketplace.git`)
- Simpler onboarding: everyone uses the same URL pattern
- No potential for token/path mismatch errors

**Cascading effects:**
- Skill repos: `/u/alice/skills/:name.git` → `/me/skills/:name.git`
- CLI output no longer needs to interpolate username
- Server routes simplified (no `:username` param to validate against token)

---

### 2. Defer Trial Logic

**Section affected:** Core Design Decisions > User-Specific Marketplaces

**Change:**
- Remove "Trial skills → Full content (time-limited server-side)" from v1 scope
- Move to future phase in Implementation Phases section

**Rationale:**
- Simplifies initial implementation
- Trial logic adds complexity (expiry tracking, grace periods, conversion flows)
- Can ship core purchase flow first, add trials later

---

### 3. Document Structure: Decisions vs Rejected Paths

**Section affected:** Entire document structure

**Change:**
- Main body = "what we're doing now" (current decisions)
- Appendix = "pathways we considered but rejected" with rationale

**New appendix sections to add:**
- "Why Not SSH?" (already exists, keep)
- "Why Not git-http-backend (CGI)?" (new — we chose `upload-pack --stateless-rpc` directly)

**Rationale:**
- Main doc reads cleanly as current architecture
- Rejected paths preserved for future reference (why we made these choices)
- Keeps decision history without cluttering the "what"

**Content for "Why Not git-http-backend?":**
- CGI returns headers + body mixed in stdout
- Requires parsing CGI response format to extract HTTP headers
- `upload-pack --stateless-rpc` gives pure data — just pipe to response
- Simpler implementation, same result
- Can upgrade to CGI later if we need push support

---

### 4. OS-Native Credential Helpers

**Section affected:** Core Design Decisions > Token-Based Authentication, CLI Tool

**Change:**
- Old: Use `store` helper (plaintext `~/.git-credentials`)
- New: Use OS-native credential helpers per platform

**Implementation:**
```typescript
const helper = process.platform === 'darwin' ? 'osxkeychain'
             : process.platform === 'win32' ? 'manager-core'
             : 'store'; // Linux fallback

execSync(`git config --global credential.https://skaas.com.helper ${helper}`);
```

**Platform mapping:**
- macOS: `osxkeychain` (Keychain Access)
- Windows: `manager-core` (Windows Credential Manager)
- Linux: `store` fallback (or `libsecret` if we want to detect it)

**Rationale:**
- Tokens stored securely in OS keychain, not plaintext
- More professional, meets user expectations
- Minimal CLI complexity (3-line platform check)
- Per-domain config doesn't affect user's other git operations

---

### 5. Remove "Server Components" Section

**Section affected:** Server Components

**Change:**
- Remove the entire "Server Components" section
- Each component's endpoints/details belong in their dedicated sections

**Rationale:**
- Duplicative: `/auth/cli` covered in CLI auth section, `/me/` covered in git server section
- Risk of specifying undiscussed details (e.g., `/api/purchases` — who said this is an API?)
- Each feature section should own its endpoints/implementation
- Avoids central list getting out of sync with detailed sections

---

### 6. Clarify Plugin vs Skill Terminology

**Section affected:** Stub Repository, throughout document

**Change:**
Add clear definitions section and use consistent terminology:

**Definitions:**
- **Creator's Source**: A full Claude Code plugin uploaded to creator's private GitHub repo
  - Contains: `plugin.json`, `skills/`, `commands/`, `hooks/`, `agents/`, etc.
- **Served Plugin**: What end-user receives from Skills Supply
  - Purchased: Creator's plugin as-is (or with minimal injection)
  - Unpurchased: Stub plugin with `/buy` command and preview content
- **Future**: Creators can upload individual skills; we wrap them into plugins

**Unit of sale:** A plugin (not individual skills)

**Rationale:**
- Removes ambiguity between "skill" (marketing term) and "plugin" (Claude Code term)
- Clarifies what creators upload vs what users receive
- Documents the transformation/injection we do

**Stub = stub plugin, not stub skill:**
The unpurchased "stub" is a minimal plugin containing:
- `plugin.json` (basic manifest)
- `SKILL.md` or similar (preview/description)
- `commands/buy.md` (purchase command)

---

### 7. Unit of Sale is "Plugin", Not "Skill"

**Section affected:** Throughout document, especially naming

**Change:**
- The thing we sell is a **plugin**
- "Skills Supply" is the platform name (marketing), but the product unit is a plugin
- Database tables, API references, etc. should use "plugin" not "skill"

**Rationale:**
- Matches Claude Code terminology
- Avoids confusion between platform name and product unit
- Creator uploads a plugin, user buys a plugin, user receives a plugin

**Naming:**
- Platform: "Skills Supply" (brand name, fine to keep)
- Product: "plugin" (what's sold)
- Table: `plugins` not `skills`

---

### 8. Remove "Data Model" Section

**Section affected:** Data Model

**Change:**
- Remove the entire "Data Model" section with SQL schemas
- Each feature section should define its own data needs

**Rationale:**
- Same issue as Server Components: mixes discussed and undiscussed details
- Who said `stripe_customer_id`? Who said `trial_days`? Who said `pricing_type` enum values?
- Central schema risks specifying things we haven't decided
- Each feature (auth, purchases, git serving) should own its data model

**What to do instead:**
- CLI Auth section defines: `cli_auth_sessions`, `api_tokens`
- Git Server section defines: `repo_state`
- Purchases section defines: purchase-related tables (when we design that)
- etc.

---

### 9. Separate CLI Document

**Section affected:** CLI Tool section

**Change:**
- Architecture doc keeps: what commands exist, what they do, why this approach
- New CLI doc gets: implementation details, code examples, credential helper logic

**Rationale:**
- CLI is super important — deserves its own detailed doc
- Keeps architecture doc focused on decisions, not implementation
- Follows same pattern as git server doc (detailed "how" lives separately)

**Architecture doc should cover:**
- Command set and purpose of each
- Auth flow at a conceptual level (browser opens, polls, stores credentials)
- Why browser-based auth (vs. entering token manually, vs. OAuth device flow, etc.)

**CLI doc should cover:**
- Full implementation code
- OS-native credential helper logic
- Polling implementation
- Error handling
- Edge cases

---

### 10. CLI Distribution Strategy

**Section affected:** CLI Tool section (new content)

**Change:**
Add CLI distribution details to architecture doc (what/why), implementation to CLI doc (how).

**Distribution approach:**
- **Written in**: TypeScript (lives in monorepo with rest of codebase)
- **Built with**: Bun (`bun build --compile` → standalone executable, no runtime needed)
- **Binary hosting**: GitHub Releases
- **Install methods**:
  1. Homebrew (homebrew-core preferred)
  2. curl script (`curl -fsSL https://skaas.com/install.sh | sh`)

**Platform targets:**
- darwin-arm64 (macOS Apple Silicon)
- darwin-x64 (macOS Intel)
- linux-x64
- windows-x64

**Rationale:**
- TypeScript: same language as rest of codebase, easier maintenance
- Bun compile: produces standalone binary, no Node/Bun runtime required on user machine
- GitHub Releases: simple, free, integrates with CI/CD
- Homebrew-core: proper package management, auto-updates, trusted source
- curl script: fallback for users without Homebrew or on Linux
- Windows: yes, include it

**Flow:**
```
TS source → Bun compile → Binaries per platform → GitHub Release
                                                      ↓
                                          ┌───────────┴───────────┐
                                          ▼                       ▼
                                    homebrew-core            install.sh
```

---

### 11. Refined Deployment Stack

**Section affected:** Deployment

**Change:**
Replace vague "or" options with concrete decisions:

**Stack:**
- **Runtime**: Node.js
- **API (including git server)**: Hono on Fly.io
  - Fly.io chosen because we need persistent disk for git repos
- **Website**: Next.js
- **Database**: PostgreSQL (Neon or GCP)
- **Structure**: Monorepo containing:
  - API package (Hono)
  - Website package (Next.js)
  - CLI package (Bun-compiled)

**Rationale:**
- Fly.io: persistent disk requirement for generated git repos
- Hono: lightweight, fast, good for git HTTP protocol
- Next.js: standard for web apps, good DX
- Monorepo: shared types, easier deployment coordination
- PostgreSQL: reliable, Neon for serverless or GCP for managed

**Additional decisions:**
- **Secrets management**: Doppler
- **No Redis**: caching strategy TBD, but not Redis for v1

**Deployment requirement to add:**
- Git must be installed on server (for `git upload-pack`)

---

### 12. Payments: Stripe Connect

**Section affected:** Payments, Implementation Phases

**Change:**
Use Stripe Connect with Express Accounts for payments.

**Decision:**
- **Platform**: Stripe Connect (Express Accounts)
- **Model**: One-time purchases for v1, subscriptions later
- **Creator onboarding**: Stripe handles KYC, bank verification, tax forms (1099s)
- **Revenue split**: Automatic per-transaction splits

**Why Stripe Connect:**
- Only platform that supports multi-vendor marketplace model
- Polar.sh, Lemon Squeezy, Gumroad are all single-merchant — can't split payments to multiple creators
- Battle-tested (Lyft, Instacart, Thumbtack, etc.)
- Automatic 1099 generation for US creators
- Scales from v1 to subscriptions

**Why not alternatives:**
| Platform | Problem |
|----------|---------|
| Polar.sh | Single merchant only, no creator payouts |
| Lemon Squeezy | Single merchant only, hidden fees (10-18%) |
| Gumroad | Single merchant only, 10% fees |

**Fee structure (example $100 plugin):**
- Card processing: 2.9% + $0.30 = $3.20
- Platform fee (e.g., 20%): $20.00
- Creator receives: $76.80
- Platform nets: $16.80

**Integration scope:**
- Creator onboarding flow (Stripe Account Links)
- Split payment logic (destination charges)
- Webhook handlers for payment/account events
- Creator dashboard for payout history

---

### 13. Remove Implementation Phases Section

**Section affected:** Implementation Phases

**Change:**
Remove the entire section with week-by-week phases and checkboxes.

**Rationale:**
- Time estimates don't belong in architecture doc
- Phasing is project management, not architecture
- Checkboxes imply a static plan — reality is more fluid
- Each feature section should be self-contained, not tied to phases

---

