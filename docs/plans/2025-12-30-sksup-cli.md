# Sync pipeline, reconciliation, and interactive commands

This ExecPlan is a living document. The sections `Progress`, `Surprises & Discoveries`, `Decision Log`, and `Outcomes & Retrospective` must be kept up to date as work proceeds. This plan must be maintained in accordance with `.agent/PLANS.md` from the repository root.

## Purpose / Big Picture

After this change, a user can manage skills end-to-end with `sk sync`, `sk pkg add/remove`, and interactive agent/package menus. Sync is a pipeline that discovers manifests, resolves packages, performs ephemeral per-agent shallow clones, detects and extracts skills, installs them, and reconciles removed skills with guardrails so only sk-created artifacts are removed. The change should be observable via `sk sync --dry-run` (no filesystem changes) and `sk sync` (installs, updates state, and removes tracked stale skills).

## Progress

- [x] (2025-12-30 15:50Z) Drafted the initial ExecPlan capturing scope, constraints, and decisions.
- [x] (2025-12-30 15:54Z) Reviewed current `packages/sk` core modules and CLI command wiring to anchor the plan to actual file paths.
- [x] (2025-12-30 16:05Z) Added core sync types, stage-tagged errors, validation, and shared IO helpers.
- [x] (2025-12-30 16:10Z) Refactored fetch to ephemeral per-agent clones and implemented agent state + reconciliation guardrails.
- [x] (2025-12-30 16:20Z) Implemented `sk sync`, `pkg add/remove/interactive`, and `agent interactive` commands plus CLI wiring.
- [x] (2025-12-30 18:20Z) Re-ran `npm run biome` and `npm run build --workspace @skills-supply/sk`, validated CLI scenarios, and captured artifacts.

## Surprises & Discoveries

- Legacy `core/pipeline` and `core/reconcile` are now empty; the active pipeline lives in `core/sync` with agent state/reconcile in `core/agents`. Treat any lingering imports as stale.
- CAC only matches the first command token, so `pkg add/remove` and `agent add/remove` must be routed inside a single `pkg`/`agent` command to avoid interactive handlers swallowing subcommands.

## Decision Log

- Decision: Defer `skillssupply-nkt` (agents.toml schema + extraction) and exclude it from this scope.
  Rationale: The user explicitly asked to ignore this bead for now.
  Date/Author: 2025-12-30 / Codex
- Decision: Reconciliation must only remove artifacts created by `sk`, guarded by a state file.
  Rationale: Avoids deleting user-owned files.
  Date/Author: 2025-12-30 / Codex
- Decision: `sk` without a command should display help, and `sk sync` should require explicit invocation; `--dry-run` must be supported.
  Rationale: Explicit operation reduces surprises; dry-run enables verification.
  Date/Author: 2025-12-30 / Codex
- Decision: `pkg remove` should require only the alias, and `pkg add` should use the already-approved syntax.
  Rationale: The user confirmed removal should only require alias and syntax is already acceptable.
  Date/Author: 2025-12-30 / Codex
- Decision: Replace cache-based fetch flow with ephemeral, per-agent shallow clones in temp directories during sync.
  Rationale: A simpler, no-cache strategy with clean updates and ephemeral temp directories.
  Date/Author: 2025-12-30 / Codex
- Decision: Group git/GitHub packages by repo + ref to reuse a single sparse checkout per agent.
  Rationale: Reduces sparse checkout duplication within a sync run while keeping per-agent isolation.
  Date/Author: 2025-12-30 / Codex
- Decision: Include warnings and manifest/package counts in the sync summary output.
  Rationale: Makes guardrail behavior and pipeline scope visible during dry-runs and installs.
  Date/Author: 2025-12-30 / Codex
- Decision: If a state file is missing, warn and skip removals; if invalid, fail the sync.
  Rationale: Missing state should not delete user content; invalid state should stop.
  Date/Author: 2025-12-30 / Codex

## Outcomes & Retrospective

Core sync pipeline, agent state/reconcile, and pkg/agent commands are implemented under `packages/sk/src/core/sync` and `packages/sk/src/core/agents`. Legacy `core/pipeline` and `core/reconcile` are empty. Validation runs completed (`npm run biome`, `npm run build --workspace @skills-supply/sk`), and CLI scenarios (sync, pkg add/remove, pkg interactive, agent interactive) were exercised. Subcommand routing for `pkg`/`agent` was adjusted to avoid CAC subcommand collisions.

## Context and Orientation

The work targets the `sk` CLI in `packages/sk`. CLI commands live under `packages/sk/src/commands`, while core logic lives under `packages/sk/src/core`. The sync pipeline is implemented in `packages/sk/src/core/sync`, with agent state and reconciliation in `packages/sk/src/core/agents`. The state file is `.sk-state.json` stored in each agent's skills directory. The design uses existing manifest and agent registry logic and integrates with `@clack/prompts` for interactive commands. No changes are allowed in `docs/*.md` for this scope.

## Plan of Work

Focus on validation and cleanup. Re-run formatting and build checks, exercise the sync and interactive commands, and align beads/plan status with what is already implemented. Capture short CLI output snippets under Artifacts and Notes and update Outcomes once validation is complete.

## Concrete Steps

Work from the repository root. Begin by running `bd ready` to review and prioritize existing issues. Verify no stale imports of `core/pipeline` or `core/reconcile` remain. Run `npm run biome` and `npm run build --workspace @skills-supply/sk`. Exercise `sk --help`, `sk sync --dry-run`, `sk sync`, `sk pkg add/remove`, and interactive commands. Update this plan with artifacts, outcomes, and any remaining gaps.

## Validation and Acceptance

From the repository root, run `npm run biome` and ensure no warnings or errors are emitted. Run `npm run build --workspace @skills-supply/sk` and ensure the CLI builds successfully. Run `sk --help` and confirm it prints usage rather than executing sync. Run `sk sync --dry-run` and verify it prints a pipeline summary without writing files. Run `sk sync` and verify it performs installs, writes `.sk-state.json`, and removes only tracked artifacts during reconciliation. Run `sk pkg add <alias> <source>` and confirm the manifest updates. Run `sk pkg remove <alias>` and confirm removal uses only the alias. Run `sk pkg` and `sk agent` interactive commands and confirm clack prompts, intro/outro usage, and expected outcomes.

## Idempotence and Recovery

The sync pipeline must be safe to re-run. Dry-run must not mutate state. Reconciliation must only delete skill directories listed in `.sk-state.json` and must refuse to delete paths outside the agent root. If a temp clone fails, the pipeline should clean up the temp directory and surface a stage-tagged error. If a state file is missing, reconciliation should skip deletions and warn; if the state file is invalid, the sync should fail.

## Artifacts and Notes

Captured CLI output snippets and state file example:

```
sk sync
Found 1 manifest(s).
Resolved 1 package(s).
Enabled agents: Codex
Would install 1 skill(s), remove 0 stale skill(s).
Done.
```

```
sk sync
Found 1 manifest(s).
Resolved 1 package(s).
Enabled agents: Codex
Installed 1 skill(s), removed 0 stale skill(s).
Done.
```

Example state file at `<agent skills dir>/.sk-state.json`:

```
{
  "skills": [],
  "updatedAt": "2025-12-30T17:01:24.037Z",
  "version": 1
}
```

Interactive validations (pseudo-TTY):
- `sk pkg` add flow (local path, alias) writes `agents.toml`; remove flow deletes selected package.
- `sk agent` multiselect renders and submits; deselect-all triggers the "select at least one option" guard.

## Interfaces and Dependencies

- In `packages/sk/src/core/sync/types.ts`, define `SyncStage`, `SyncError`, `SyncResult<T>`, `ExtractedPackage`, and `SyncSummary`.
- In `packages/sk/src/core/sync/errors.ts`, define stage-tagged error helpers (`failSync`).
- In `packages/sk/src/core/sync/validate.ts`, define invariant validation for extracted packages.
- In `packages/sk/src/core/io/fs.ts`, define IO helpers returning a consistent `IoError` shape.
- In `packages/sk/src/core/agents/state.ts`, define the `.sk-state.json` read/write helpers and state type.
- In `packages/sk/src/core/agents/reconcile.ts`, define reconciliation using state to remove stale skills.
- In `packages/sk/src/commands`, wire `sync`, `pkg add/remove/interactive`, and `agent interactive` commands to the core pipeline and manifest/registry helpers.

## Plan Revision Notes

Initial plan authored on 2025-12-30 to cover sync pipeline, reconciliation, command updates, and the no-cache fetch strategy. Updated on 2025-12-30 to align with the `core/sync` migration, agent state/reconcile modules, and current validation status.
